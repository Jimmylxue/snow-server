## 排行榜相关

### 考试次数排行榜

![image-20250404114708187](https://image.jimmyxuexue.top/img/image-20250404114708187.png)

```tsx
import React, { useEffect } from 'react';
import { Box, Text, VStack, HStack, ScrollView } from 'native-base';
import LinearGradient from 'react-native-linear-gradient';
import { StyleSheet } from 'react-native';
import { useNavigation } from '@react-navigation/native';
import { useExamRank } from '../../service/study';

// type ExamRankParams = {
//   subjectId: number;
// };

export default function CountRank() {
  const navigation = useNavigation();

  // const route = useRoute<RouteProp<Record<string, ExamRankParams>, string>>();
  // const { subjectId } = route.params;
  const { data: examRank } = useExamRank(['examRank'], {});
  console.log('examRank', examRank);

  useEffect(() => {
    navigation.setOptions({
      title: '历史考试次数排行榜',
    });
  }, [navigation]);

  return (
    <ScrollView bg="white">
      {/* 顶部渐变背景 */}
      <LinearGradient
        colors={['#4c669f', '#3b5998', '#192f6a']}
        style={styles.headerGradient}>
        <VStack space={2} alignItems="center" pt={6} pb={8}>
          <Text color="white" fontSize="lg">
            📚 历史考试次数排行版
          </Text>
          <Text color="white" fontSize="4xl" fontWeight="bold">
            {examRank?.exam_count}
          </Text>
          <Text color="white">考试次数</Text>
        </VStack>
      </LinearGradient>

      {/* 统计信息卡片 */}
      <Box style={styles.statsCard}>
        <VStack space={4}>
          {/* 超越人数百分比 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <HStack justifyContent="space-between" alignItems="center">
              <Text fontSize="md">超越用户</Text>
              <HStack alignItems="center" space={2}>
                <Text fontSize="2xl" color="#4c669f" fontWeight="bold">
                  {examRank?.exceedPercentage}
                </Text>
                <Text fontSize="lg">🏃</Text>
              </HStack>
            </HStack>
          </Box>

          {/* 与上名差距 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <VStack space={2}>
              <HStack justifyContent="space-between">
                <Text fontSize="md">与上名差距</Text>
                <HStack alignItems="center" space={2}>
                  <Text fontSize="xl" color="#4c669f" fontWeight="bold">
                    {examRank?.gapWithPrev}
                  </Text>
                  <Text fontSize="lg">⬆️</Text>
                </HStack>
              </HStack>
              <Text fontSize="sm" color="gray.500">
                上名成绩：{examRank?.prevUserExamCount}次
              </Text>
            </VStack>
          </Box>

          {/* 与第一名差距 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <VStack space={2}>
              <HStack justifyContent="space-between">
                <Text fontSize="md">距离第一名</Text>
                <HStack alignItems="center" space={2}>
                  <Text fontSize="xl" color="#4c669f" fontWeight="bold">
                    {examRank?.gapWithFirst}
                  </Text>
                  <Text fontSize="lg">👑</Text>
                </HStack>
              </HStack>
              <Text fontSize="sm" color="gray.500">
                第一名考试次数：{examRank?.firstUserCount}分
              </Text>
            </VStack>
          </Box>

          {/* 当前排名 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <HStack justifyContent="space-between" alignItems="center">
              <Text fontSize="md">当前排名</Text>
              <HStack alignItems="center" space={2}>
                <Text fontSize="2xl" color="#4c669f" fontWeight="bold">
                  {examRank?.rank}
                </Text>
                <Text fontSize="lg">🏆</Text>
              </HStack>
            </HStack>
          </Box>
        </VStack>
      </Box>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  headerGradient: {
    minHeight: 200,
    borderBottomLeftRadius: 30,
    borderBottomRightRadius: 30,
  },
  statsCard: {
    marginTop: -30,
    marginHorizontal: 16,
    padding: 16,
    borderRadius: 20,
    backgroundColor: 'rgba(246,246,246,0.9)',
  },
});

```

### 自习学习时间排行榜

![image-20250404114812049](https://image.jimmyxuexue.top/img/image-20250404114812049.png)

```ts
import React, { useEffect } from 'react';
import { Box, Text, VStack, HStack, ScrollView } from 'native-base';
import LinearGradient from 'react-native-linear-gradient';
import { StyleSheet } from 'react-native';
import { useNavigation } from '@react-navigation/native';
import { useStudyRoomStatus } from '../../service/study';
export default function StudyRank() {
  const navigation = useNavigation();

  const { data: studyRoomStatus } = useStudyRoomStatus(['studyRoomStatus'], {});

  useEffect(() => {
    navigation.setOptions({
      title: '自习排行榜',
    });
  }, [navigation]);

  return (
    <ScrollView bg="white">
      {/* 顶部渐变背景 */}
      <LinearGradient
        colors={['#4c669f', '#3b5998', '#192f6a']}
        style={styles.headerGradient}>
        <VStack space={2} alignItems="center" pt={6} pb={8}>
          <Text color="white" fontSize="lg">
            📚 自习室学习时长排行
          </Text>
          <Text color="white" fontSize="4xl" fontWeight="bold">
            {studyRoomStatus?.studyTime || 0}
          </Text>
          <Text color="white">总学习时间</Text>
        </VStack>
      </LinearGradient>

      {/* 统计信息卡片 */}
      <Box style={styles.statsCard}>
        <VStack space={4}>
          {/* 超越人数百分比 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <HStack justifyContent="space-between" alignItems="center">
              <Text fontSize="md">超越用户</Text>
              <HStack alignItems="center" space={2}>
                <Text fontSize="2xl" color="#4c669f" fontWeight="bold">
                  {studyRoomStatus?.exceedPercentage}
                </Text>
                <Text fontSize="lg">🏃</Text>
              </HStack>
            </HStack>
          </Box>

          {/* 与上名差距 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <VStack space={2}>
              <HStack justifyContent="space-between">
                <Text fontSize="md">与上名差距</Text>
                <HStack alignItems="center" space={2}>
                  <Text fontSize="xl" color="#4c669f" fontWeight="bold">
                    {studyRoomStatus?.gapWithPrev}分钟
                  </Text>
                  <Text fontSize="lg">⬆️</Text>
                </HStack>
              </HStack>
              <Text fontSize="sm" color="gray.500">
                上名成绩：{studyRoomStatus?.prevUserStudyTime}分
              </Text>
            </VStack>
          </Box>

          {/* 与第一名差距 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <VStack space={2}>
              <HStack justifyContent="space-between">
                <Text fontSize="md">距离第一名</Text>
                <HStack alignItems="center" space={2}>
                  <Text fontSize="xl" color="#4c669f" fontWeight="bold">
                    {studyRoomStatus?.gapWithFirst}分钟
                  </Text>
                  <Text fontSize="lg">👑</Text>
                </HStack>
              </HStack>
              <Text fontSize="sm" color="gray.500">
                第一名学习时间：{studyRoomStatus?.firstUserStudyTime}分钟
              </Text>
            </VStack>
          </Box>

          {/* 当前排名 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <HStack justifyContent="space-between" alignItems="center">
              <Text fontSize="md">当前排名</Text>
              <HStack alignItems="center" space={2}>
                <Text fontSize="2xl" color="#4c669f" fontWeight="bold">
                  {studyRoomStatus?.rank}
                </Text>
                <Text fontSize="lg">🏆</Text>
              </HStack>
            </HStack>
          </Box>
        </VStack>
      </Box>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  headerGradient: {
    minHeight: 200,
    borderBottomLeftRadius: 30,
    borderBottomRightRadius: 30,
  },
  statsCard: {
    marginTop: -30,
    marginHorizontal: 16,
    padding: 16,
    borderRadius: 20,
    backgroundColor: 'rgba(246,246,246,0.9)',
  },
});

```



### 科目考试排行榜

![image-20250404114949267](https://image.jimmyxuexue.top/img/image-20250404114949267.png)

```tsx
import React, { useEffect } from 'react';
import { Box, Text, VStack, HStack, ScrollView } from 'native-base';
import LinearGradient from 'react-native-linear-gradient';
import { StyleSheet } from 'react-native';
import { RouteProp, useNavigation, useRoute } from '@react-navigation/native';
import { useExamScoreRank } from '../../service/study';

type ExamRankParams = {
  subjectId: number;
};

export default function ExamRank() {
  const navigation = useNavigation();

  const route = useRoute<RouteProp<Record<string, ExamRankParams>, string>>();
  const { subjectId } = route.params;
  const { data: examScoreRank } = useExamScoreRank(
    ['examScoreRank', subjectId],
    { examProjectId: +subjectId },
  );

  console.log('examScoreRank', examScoreRank);
  const examInfo = {
    subject: '2024年真题一次模拟试卷',
    highestScore: 95,
    totalStudents: 1000,
    currentRank: 56,
    nextScore: 96,
    topScore: 100,
    percentage: 94.4, // 超越的百分比
  };

  useEffect(() => {
    navigation.setOptions({
      title: '数学排行榜',
    });
  }, [navigation]);

  return (
    <ScrollView bg="white">
      {/* 顶部渐变背景 */}
      <LinearGradient
        colors={['#4c669f', '#3b5998', '#192f6a']}
        style={styles.headerGradient}>
        <VStack space={2} alignItems="center" pt={6} pb={8}>
          <Text color="white" fontSize="lg">
            📚 {examInfo.subject}
          </Text>
          <Text color="white" fontSize="4xl" fontWeight="bold">
            {examScoreRank?.bestScore}
          </Text>
          <Text color="white">历史最高分</Text>
        </VStack>
      </LinearGradient>

      {/* 统计信息卡片 */}
      <Box style={styles.statsCard}>
        <VStack space={4}>
          {/* 超越人数百分比 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <HStack justifyContent="space-between" alignItems="center">
              <Text fontSize="md">超越用户</Text>
              <HStack alignItems="center" space={2}>
                <Text fontSize="2xl" color="#4c669f" fontWeight="bold">
                  {examScoreRank?.beatPercentage}%
                </Text>
                <Text fontSize="lg">🏃</Text>
              </HStack>
            </HStack>
          </Box>

          {/* 与上名差距 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <VStack space={2}>
              <HStack justifyContent="space-between">
                <Text fontSize="md">与上名差距</Text>
                <HStack alignItems="center" space={2}>
                  <Text fontSize="xl" color="#4c669f" fontWeight="bold">
                    {examScoreRank?.gapToPrev}
                  </Text>
                  <Text fontSize="lg">⬆️</Text>
                </HStack>
              </HStack>
              <Text fontSize="sm" color="gray.500">
                上名成绩：{examScoreRank?.prevRankScore}分
              </Text>
            </VStack>
          </Box>

          {/* 与第一名差距 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <VStack space={2}>
              <HStack justifyContent="space-between">
                <Text fontSize="md">距离第一名</Text>
                <HStack alignItems="center" space={2}>
                  <Text fontSize="xl" color="#4c669f" fontWeight="bold">
                    {examScoreRank?.gapToFirst}
                  </Text>
                  <Text fontSize="lg">👑</Text>
                </HStack>
              </HStack>
              <Text fontSize="sm" color="gray.500">
                第一名成绩：{examScoreRank?.firstScore}分
              </Text>
            </VStack>
          </Box>

          {/* 当前排名 */}
          <Box bg="rgba(255,255,255,0.9)" p={4} rounded="lg" shadow={2}>
            <HStack justifyContent="space-between" alignItems="center">
              <Text fontSize="md">当前排名</Text>
              <HStack alignItems="center" space={2}>
                <Text fontSize="2xl" color="#4c669f" fontWeight="bold">
                  {examScoreRank?.rank}
                </Text>
                <Text fontSize="lg">🏆</Text>
              </HStack>
            </HStack>
          </Box>
        </VStack>
      </Box>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  headerGradient: {
    minHeight: 200,
    borderBottomLeftRadius: 30,
    borderBottomRightRadius: 30,
  },
  statsCard: {
    marginTop: -30,
    marginHorizontal: 16,
    padding: 16,
    borderRadius: 20,
    backgroundColor: 'rgba(246,246,246,0.9)',
  },
});
```

### 管库员页面

![image-20250404115401806](https://image.jimmyxuexue.top/img/image-20250404115401806.png)

![image-20250404115418064](https://image.jimmyxuexue.top/img/image-20250404115418064.png)

```tsx
import {
  Button,
  CheckIcon,
  FormControl,
  Input,
  Select,
  TextArea,
  Toast,
  View,
} from 'native-base';
import React, { SafeAreaView } from 'react-native';
import { useState } from 'react';
import { adaptive } from '../../utils';
import { EExamType, useExamType, useAddExam } from '../../service/exam';

export function UploadExam() {
  const [typeId, setTypeId] = useState<string>('');
  const [name, setName] = useState<string>('');
  const [desc, setDesc] = useState<string>('');
  const [examType, setExamType] = useState<string>('');
  const [option, setOption] = useState<string>('');
  const [answer, setAnswer] = useState<string>('');
  const { data } = useExamType(['examType'], {}, {});
  // console.log('data', data);

  const { mutateAsync } = useAddExam({
    onSuccess: () => {
      Toast.show({ title: '添加成功' });
      setTypeId('');
      setName('');
      setDesc('');
      setExamType('');
      setOption('');
      setAnswer('');
    },
    onError: error => {
      Toast.show({ title: '添加失败' });
      console.log('error', error);
    },
  });

  return (
    <SafeAreaView>
      <View
        px={2}
        style={{
          paddingTop: adaptive(280),
        }}>
        <FormControl>
          <FormControl.Label>{'题目名称'}</FormControl.Label>
          <Input
            placeholder={'请输入题目名称'}
            w="100%"
            value={name}
            onChangeText={val => setName(val)}
          />
        </FormControl>
        <FormControl>
          <FormControl.Label>{'题目描述'}</FormControl.Label>
          <Input
            placeholder={'请输入题目描述'}
            w="100%"
            value={desc}
            onChangeText={val => setDesc(val)}
          />
        </FormControl>
        <FormControl>
          <FormControl.Label>{'题目类型'}</FormControl.Label>
          <Select
            selectedValue={typeId}
            minWidth="200"
            accessibilityLabel="选择课程类型"
            placeholder="Choose Service"
            _selectedItem={{
              bg: 'teal.600',
              endIcon: <CheckIcon size="5" />,
            }}
            mt={1}
            onValueChange={itemValue => {
              console.log('itemValue', itemValue);
              setTypeId(itemValue);
            }}>
            {data?.map(type => (
              <Select.Item
                key={type.id}
                label={type.name}
                value={String(type.id)}
              />
            ))}
          </Select>
        </FormControl>

        <FormControl>
          <FormControl.Label>{'考题方式'}</FormControl.Label>
          <Select
            selectedValue={examType}
            minWidth="200"
            accessibilityLabel="选择课程类型"
            placeholder="Choose Service"
            _selectedItem={{
              bg: 'teal.600',
              endIcon: <CheckIcon size="5" />,
            }}
            mt={1}
            onValueChange={itemValue => setExamType(itemValue)}>
            <Select.Item label={'选择题'} value={'1'} />
            <Select.Item label={'判断题'} value={'2'} />
          </Select>
        </FormControl>

        {+examType === EExamType.选择题 && (
          <FormControl>
            <FormControl.Label>{'题目选项'}</FormControl.Label>
            {/* @ts-ignore */}
            <TextArea
              aria-label="t1"
              numberOfLines={4}
              placeholder={'请输入题目选项，以@隔开'}
              // isInvalid
              _dark={{
                placeholderTextColor: 'gray.300',
              }}
              mb="5"
              value={option}
              onChangeText={val => setOption(val)}
            />
          </FormControl>
        )}

        <FormControl>
          <FormControl.Label>{'标准答案'}</FormControl.Label>
          <Input
            placeholder={'请输入数字，代表正确答案是第几项，判断题只能输入1或2'}
            w="100%"
            value={answer}
            onChangeText={val => setAnswer(val)}
          />
        </FormControl>

        <Button
          onPress={async () => {
            const isXuanZe = Number(examType) === EExamType.选择题;
            if (!isXuanZe) {
              // 判断题
              if (!['1', '2'].includes(answer)) {
                Toast.show({ title: '判断题超过范围' });
                return;
              }
            }
            console.log('examType', examType);
            console.log('option', option, typeId);
            const params = {
              name,
              desc,
              typeId: Number(typeId),
              examType: Number(examType),
              option: isXuanZe ? option : '对@错',
              answer: answer,
            };
            await mutateAsync(params);
          }}
          mt={2}>
          上传题目
        </Button>
      </View>
    </SafeAreaView>
  );
}
```

## 数据库表相关改动

```ts
@Entity('examRecord', { schema: 'snow-server' })
export class ExamRecord {
  @PrimaryGeneratedColumn({ type: 'int', name: 'id', comment: '考试记录id' })
  id: number;

  @Column('int', { name: 'userId', comment: '用户id' })
  userId: number;

  @ManyToOne(() => User, (user) => user.id, {
    onDelete: 'CASCADE',
  })
  @JoinColumn({ name: 'userId' })
  user: number;

  @ManyToOne(() => ExamProject, (examProject) => examProject.id, {
    onDelete: 'CASCADE',
  })
  @JoinColumn({ name: 'examProjectId' })
  examProject: number;

  @Column('int', { name: 'examProjectId', comment: '考试项目id' })
  examProjectId: number;

  @Column('text', { name: 'desc', comment: '考试心得' })
  desc: string;

  @Column('int', { name: 'useTime', comment: '考试用时' })
  useTime: number;

  @Column('int', { name: 'remainTime', comment: '剩余时间' })
  remainTime: number;

  @Column('int', { name: 'overTime', comment: '超时时间' })
  overTime: number;

  @Column('int', { name: 'totalScore', comment: '总得分' })
  totalScore: number;

  @Column('text', { name: 'paperDesc', comment: '试卷名称' })
  paperText: string;

  @CreateDateColumn({ comment: '创建时间', type: 'timestamp' })
  createdTime: Date;

  @UpdateDateColumn({ comment: '更新时间', type: 'timestamp' })
  updateTime: Date;
}
```

